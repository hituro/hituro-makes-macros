window.Schedule=class a{constructor(a,b){for(let c in this.schedule=a??{},this.datesystem=b??"default",a)a[c]=this.parseEvent(c,a[c])}parseEvent(a,b){b=Array.isArray(b)?b:[b];const c=[];for(let d of b){let[a,b]=d.split(" -> ");c.push({start:DATESYSTEM.dateQueryFromString(a),end:DATESYSTEM.dateQueryFromString(b)})}return{event:a,when:c}}get ds(){return setup.datesystems[this.datesystem]}add(a,b){this.schedule[a]=this.parseEvent(a,b)}check(a,b){return b=b??variables()[this.ds.varname],"number"==typeof b&&(b=this.ds.getDate(b)),this.isValid(this.schedule[a],b)}events(a){return a=a??variables()[this.ds.varname],"number"==typeof a&&(a=this.ds.getDate(a)),Object.values(this.schedule).filter(b=>this.isValid(b,a))}isValid(a,b){return a.when.some(a=>{if(a.start&&a.end){let c=this.ds.dateFromPartialDate(a.start),d=this.ds.dateFromPartialDate(a.end);return c<=b.e&&d>=b.e}return this.ds.dateCompare(a.start,b)})}toJSON(){return JSON.reviveWrapper(String.format("new Schedule({0},{1})",JSON.stringify(this.schedule),JSON.stringify(this.datesystem)))}clone(){return new a(this.schedule,this.datesystem)}},Macro.add("schedule",{tags:["event"],handler:function(){if(!this.args.length||!["$","_"].contains(this.args[0][0]))throw new Error("Argument one must be the name of a story or temporary variable");const a=this.args[0],b=this.args[1]??"default",c={};for(let a of this.payload)console.log(a),"event"==a.name&&(c[a.args[0]]=a.args[1]);State.setVar(a,new Schedule(c,b))}}),Macro.add("addevent",{handler:function(){if(!this.args.length||!["$","_"].contains(this.args[0][0]))throw new Error("Argument one must be the name of a story or temporary variable");const a=this.args[0],b=State.getVar(a);if(!(b instanceof Schedule))throw new Error("Argument one is not a valid Schedule");b.add(this.args[1],this.args[2])}}),Macro.add("removeevent",{handler:function(){if(!this.args.length||!["$","_"].contains(this.args[0][0]))throw new Error("Argument one must be the name of a story or temporary variable");const a=this.args[0],b=State.getVar(a);if(!(b instanceof Schedule))throw new Error("Argument one is not a valid Schedule");delete b.schedule[this.args[1]]}});