(function(){State.variables.chatsystem={},setup["@CHATSYSTEM/Options"]={tails:!0},window.CHATSYSTEM=class{static version="1.0.0";static interval=864e5;static initChat(a){Object.hasOwn(State.variables.chatsystem,a)||(State.variables.chatsystem[a]=[])}static conversationId(c,a){return[c,a].flat().sort().join("_").toLowerCase()}static addMsg(a,b){const c=State.variables.chatsystem;c[a].push(b),b.date&&c[a].sort((c,a)=>c.date-a.date);triggerEvent(":redo",document,{detail:{tags:[a]}})}static currentId(a){const b=State.variables.chatsystem;return Array.isArray(b[a])&&b[a].length?b[a][b[a].length-1].id:0}static addTyping(a){$(`#${a}`).append("<div class='chat_msg chat_msg_to typing'></div>")}static date(a,b){const c=(a.getTime()-b.getTime())/86400000;let d="";d=2>c?a.getDay()==b.getDay()?"Today":"Yesterday":7>c?new Intl.DateTimeFormat("en-US",{weekday:"long"}).format(b):new Intl.DateTimeFormat("en-US",{weekday:"short",day:"numeric",year:"numeric"}).format(b);const e=new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"numeric"}).format(b);return`<div class="date">${d} ${e}</div>`}static deleteMsg(a,b){const c=State.variables.chatsystem;c[a].deleteWith(a=>a.id===b)}static deleteChat(a){const b=State.variables.chatsystem;delete b[a]}},window.macroPairedArgsParser=function(a,b=0,c=[]){const d={};let e="";for(let f,g=b;g<a.length;g+=1)f=a[g].replace(/[^a-zA-Z0-9_]/g,""),c.includes(f)?d[f]=!0:("and"==f?Array.isArray(d[e])?d[e].push(a[g+1]):d[e]=[d[e],a[g+1]]:(d[f]=a[g+1],e=f),g++);return d},Macro.add("msg",{tags:null,handler:function(){const a=State.variables.chatsystem,b="object"==typeof this.args[0]?this.args[0]:macroPairedArgsParser(this.args);b.from||this.error("You must specify a from."),b.to||this.error("You must specify a to."),Array.isArray(b.to)||(b.to=[b.to]);const c=CHATSYSTEM.conversationId(b.from,b.to);CHATSYSTEM.initChat(c),b.id||(b.id=a[c].length),b.text||(b.text=this.payload[0].contents.trim()),b.date&&!(b.date instanceof Date)&&(b.date=new Date(b.date)),b.text=$("<span>").wiki(b.text).html(),b.delay&&this.contextFind(a=>"chat"==a.name)?(CHATSYSTEM.addTyping(c),setTimeout(()=>CHATSYSTEM.addMsg(c,b),Util.fromCssTime(b.delay))):CHATSYSTEM.addMsg(c,b)}}),Macro.add("msg-delete",{handler:function(){const a=State.variables.chatsystem,b="object"==typeof this.args[0]?this.args[0]:macroPairedArgsParser(this.args);b.from||this.error("You must specify a from."),b.to||this.error("You must specify a to."),b.id||this.error("You must specify a msg id to delete."),Array.isArray(b.to)||(b.to=[b.to]);const c=CHATSYSTEM.conversationId(b.from,b.to);CHATSYSTEM.deleteMsg(c,b.id)}}),Macro.add("history",{handler:function(){const a=State.variables.chatsystem,b=this.contextFind(a=>"chat"==a.name),c=b?.self?.conf??("object"==typeof this.args[0]?this.args[0]:macroPairedArgsParser(this.args,1));c.from||(c.from=this.args[0]),Array.isArray(c.with)||(c.with=[c.with]),c.at&&!(c.at instanceof Date)&&(c.at=new Date(c.at));const d=CHATSYSTEM.conversationId(c.from,c.with);d||this.error("You must specify who the chat is between");const e=$(`<div class="chat_sequence" id="${d}">`),f=setup["@CHATSYSTEM/Options"]?.tails?"tails":"";let g={date:0,from:""};for(const[b,h]of a[d].entries()){let a=h.from==c.from?"from":"to";c.at&&h.date&&(h.date.getTime()-g.date>CHATSYSTEM.interval&&e.append(CHATSYSTEM.date(c.at,h.date)),g.date=h.date.getTime()),h.title&&e.append(`<div class='date'>${h.title}</div>`),1<c.with.length&&h.from!=g.from&&(h.from!=c.from&&e.append(`<div class='chat_from chat_msg_${a} chat_name_${h.from.replace(" ","_").toLowerCase()}'>${h.from}</div>`),g.from=h.from),e.append($(`
                <div class="chat_msg ${f}
                            chat_msg_${h.from.replace(" ","_").toLowerCase()} 
                            chat_msg_${a}">
                    <p>${h.text}</p>
                </div>
            `))}State.temporary.curr=CHATSYSTEM.currentId(d),$(this.output).append(e)}}),Macro.add("chat",{tags:null,conf:{},handler:function(){this.self.conf="object"==typeof this.args[0]?this.args[0]:macroPairedArgsParser(this.args,1);const a=this.self.conf;a.from||(a.from=this.args[0]),Array.isArray(a.with)||(a.with=[a.with]);const b=CHATSYSTEM.conversationId(a.from,a.with);CHATSYSTEM.initChat(b),$(this.output).wiki(`<<nobr>>
                <div class='chat_container'>
                    <<do tag "${b}" element "div">>
                        <<history>>
                        <div class='chat_response'>
                            ${this.payload[0].contents}
                        </div>
                    <</do>>
                </div><</nobr>>`)}}),Macro.add("chat-delete",{handler:function(){const a="object"==typeof this.args[0]?this.args[0]:macroPairedArgsParser(this.args,1);a.from||(a.from=this.args[0]),Array.isArray(a.with)||(a.with=[a.with]);const b=CHATSYSTEM.conversationId(a.from,a.with);CHATSYSTEM.deleteChat(b)}})})();