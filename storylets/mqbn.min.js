window.MQBN=class a{version="1.5.1";static getStorylets(b,c="storylets",d=!0){const e=[];let f=-Infinity,g=0;for(let h of setup[c].sort(a.prioritySort))if(this.meetsRequirements(h,c)&&(g++,(h.priority??0)>=f&&e.push(h),g==b&&(f=h.priority??0,!d)))break;return temporary()[c+"_available"]=e,e.slice(0,b).sort(a.weightSort)}static prioritySort(c,a){const b=c.priority??0,d=a.priority??0;return b==d?randomFloat(0,1)-.5:b>d?-1:1}static weightSort(c,a){return c.priority&&!a.priority?1:c.weight==a.weight?0:c.weight>a.weight?1:-1}static meetsRequirements(a,b="storylets"){if(!a.sticky&&variables()[b+"_used"].has(a.id?a.id:a.title))return!1;if(a.all)for(const c of a.all)if(!this[c.type+"Requirement"](c,b))return!1;if(a.any){for(const c of a.any)if(this[c.type+"Requirement"](c,b))return!0;return!1}return!0}static anyRequirement(a,b){return this.meetsRequirements(a,b)}static allRequirement(a,b){return this.meetsRequirements(a,b)}static twsRequirement(a){return!!Scripting.evalTwineScript(a.cond)}static visitedRequirement(a){return"not"==a.op?!visited(a.passage):visited(a.passage)}static varRequirement(a){return this.operators[a.op??"eq"](State.getVar(a.var),a.value)}static sequenceRequirement(a){return a.count?this.operators[a.op??"eq"](State.getVar(a.seq).count,a.count):a.value?this.operators[a.op??"eq"](State.getVar(a.seq).value,a.value):this.operators["not"==a.op?"neq":"eq"](State.getVar(a.seq).name,a.name)}static playedRequirement(a,b){return"not"==a.op?!variables()[b+"_used"].has(a.story):variables()[b+"_used"].has(a.story)}static collectionRequirement(a){const b=State.getVar(a.var);let c;if(b instanceof Set||b instanceof Map)c=b.has(a.has);else if(b instanceof Array)c=b.includes(a.has);else if("Object"==Util.toStringTag(b))c=Object.hasOwn(b,a.has)&&b[a.has];else throw`The variable ${a.var} is not any kind of collection`;return"not"==a.op?!c:c}static functionRequirement(a,b){return a.func(a,b)}static randRequirement(a){let b=this.getRandomInt(1,100);return b<=a.chance}static pullsRequirement(a,b){return this.operators[a.op??"eq"](a.pulls,variables()[b+"_used"].size)}static operators={eq:function(c,a){return c==a},neq:function(c,a){return c!=a},lt:function(c,a){return c<a},gt:function(c,a){return c>a},lte:function(c,a){return c<=a},gte:function(c,a){return c>=a},includes:function(c,a){return Array.isArray(c)&&c.includes(a)},notincludes:function(c,a){return Array.isArray(c)&&!c.includes(a)},has:function(c,a){return(c instanceof Set||c instanceof Map)&&c.has(a)}};static trigger(a){$(document).trigger({type:":storyletchosen",storylet:a})}static getRandomInt(a,b){return Math.random()*(b-a)+a}static played(a,b="storylets"){return this.playedRequirement({story:a},b)}static storyletscan(){const a=/<<storylet(?:| ([A-z_-]*))>>/,b=/<<storylet([A-z_ -]*)>>([\S\s]*)<<\/storylet>>/,c=/<<cond>>([\S\s]*)<<\/cond>>/;Story.filter(b=>b.text.match(a)).forEach(d=>{const e=d.text.match(a)[1]??"storylets";e in setup||(this.storyletsinit(e),setup[e]=[]);const f=d.text.match(b)[2].trim();let g;if(f.match(c)){let a=f.match(c),b=a[1];g=f.replace(a[0],"").trim(),g=g?Scripting.evalJavaScript(`(${g})`):{},g.any=[{type:"tws",cond:b}]}else g="{"==f[0]?Scripting.evalJavaScript(`(${f})`):0==f.length?{}:{any:[{type:"tws",cond:f}]};g.id=g.id??d.name,g.title=g.title??d.title,g.passage=d.title,setup[e].push(g)})}static storyletsinit(a="storylets"){State.variables[a+"_used"]||State.setVar("$"+a+"_used",new Map),State.variables[a+"_current"]||State.setVar("$"+a+"_current",!1)}static pruneStorylets(a="storylets"){setup[a]=setup[a].filter(b=>!variables()[a+"_used"].has(b.id??b.title))}static createSequence(a,b,c="linear"){let d=0;if("Object"==Util.toStringTag(b)){let a=[],c=!1;for(let e in b)c||(d=e,c=!0),a[e]=b[e];b=a}const e=new Sequence(b,d);State.setVar(a,e)}},window.Sequence=class a{constructor(a,b,c="linear",d=1){this.values=a,this.val=b,this.mode=c,this.name=this.getSequenceName(),this.count=d}get value(){return this.val}set value(a){this.sequenceChange(a-this.val)}toString(){return this.name}[Symbol.toPrimitive](a){return"string"==a?this.name:this.value}getSequenceName(){let a="";for(let b in this.values){if(b>this.val)return a;a=this.values[b]}return a}sequenceChange(a){var b=Math.abs,c=Math.floor;const d=this.val,e=this.values.length;let f;"linear"==this.mode?f=Math.max(Math.min(d+a,e-1),0):"cycling"==this.mode&&(f=d+a,0<a&&f>e-1?this.count+=c(f/e):0>a&&0>f&&(this.count-=b(c(f/e))),f=b(f%e)),this.name=this.getSequenceName(f),this.val=f}toJSON(){return JSON.reviveWrapper(String.format("new Sequence({0},{1},{2},{3})",JSON.stringify(this.values),JSON.stringify(this.val),JSON.stringify(this.mode),JSON.stringify(this.count)))}clone(){return new a(this.values,this.val,this.mode,this.count)}},window.macroPairedArgsParser=function(a,b=0,c=[]){const d={};for(let e=b;e<a.length;e+=1)c.includes(a[e])?d[a[e]]=!0:(d[a[e].replace(/[^a-zA-Z0-9_]/g,"")]=a[e+1],e++);return d},Macro.add(["storyletsinit","initstorylets"],{handler:function(){MQBN.storyletsinit(this.args[0])}}),Macro.add(["storyletsprune","prunestorylets"],{handler:function(){MQBN.pruneStorylets(this.args[0])}}),Macro.add("storyletgoto",{handler:function(){if(0===this.args.length)return this.error(`no storylet specified`);const a=macroPairedArgsParser(this.args,1),b=a.store??"storylets",c=a.open??!1;let d;if("object"==typeof this.args[0])d=this.args[0];else{const a=setup[b].filter(a=>a.title==this.args[0]||a.id==this.args[0]);if(c){const c=a.toSorted(MQBN.prioritySort).filter(a=>MQBN.meetsRequirements(a,b));d=!!c.length&&c[0]}else d=a[0]}if(d){const a=d.passage??d.title;variables()[b+"_used"].set(d.id??d.title),variables()[b+"_current"]=d,MQBN.trigger(d),setTimeout(()=>Engine.play(a),Engine.minDomActionDelay)}}}),Macro.add("storyletinclude",{handler:function(){if(0===this.args.length)return this.error(`no storylet specified`);const a=macroPairedArgsParser(this.args,1),b=a.store??"storylets",c=a.open??!1;let d;if("object"==typeof this.args[0])d=this.args[0];else{const a=setup[b].filter(a=>a.title==this.args[0]||a.id==this.args[0]);if(c){const c=a.toSorted(MQBN.prioritySort).filter(a=>MQBN.meetsRequirements(a,b));d=!!c.length&&c[0]}else d=a[0]}if(d){const a=d.passage??d.title;variables()[b+"_used"].set(d.id??d.title),variables()[b+"_current"]=d,MQBN.trigger(d),jQuery(this.output).wiki(Story.get(a).processText())}}}),Macro.add("storyletlink",{tags:null,handler(){if(0===this.args.length)return this.error("no storylet specified");const a=macroPairedArgsParser(this.args,1),b=a.store??"storylets",c=a.behaviour??"hidden",d=this.payload[0].contents.trim(),e=jQuery(document.createElement("a"));let f;if("object"==typeof this.args[0])f=this.args[0];else{temporary()[b+"_available"]||MQBN.getStorylets(0,b);const a=temporary()[b+"_available"].find(a=>a.title==this.args[0]||a.id==this.args[0]);a&&(f=a)}if(f){e.append(document.createTextNode(a.text??f.link??f.title));let c=f.passage??f.title;null!=c&&(e.attr("data-passage",c),Story.has(c)?Config.addVisitedLinkClass&&State.hasPlayed(c)&&e.addClass("link-visited"):e.addClass("link-broken")),e.addClass("macro-storylet-link").addClass("link-internal").ariaClick({namespace:".macros",role:null==c?"button":"link",one:null!=c},this.createShadowWrapper(function(){variables()[b+"_used"].set(f.id??f.title),variables()[b+"_current"]=f,d&&Wikifier.wikifyEval(d)},null==c?null:()=>{MQBN.trigger(f),Engine.play(c)})).appendTo(this.output)}else if("disabled"==c&&"string"==typeof this.args[0])if(f=setup[b].find(a=>a.id==this.args[0]||a.title==this.args[0]),f)jQuery(this.output).wiki(`<span class="link-disabled">${a.disabledtext??f.link??f.title}</span>`);else return this.error(`storylet ${this.args[0]} cannot be found`)}}),Macro.add("storyletuse",{handler:function(){if(0===this.args.length)return this.error(`no storylet specified`);const a=macroPairedArgsParser(this.args,1),b=a.store??"storylets";let c;if("object"==typeof this.args[0])c=this.args[0];else{setup[b].find(a=>a.title==this.args[0]||a.id==this.args[0])}c&&(variables()[b+"_used"].set(c.id??c.title),variables()[b+"_current"]=c)}}),Macro.add("storyletscan",{handler:function(){MQBN.storyletscan()}}),Macro.add("storylet",{tags:[],handler:function(){}}),Macro.add("sequence",{handler:function(){return 0===this.args.length?this.error("no sequence name specified"):"linear"!=this.args[1]&&"cycling"!=this.args[1]?this.error(`argument 2 must be either linear or cycling, ${this.args[1]} found`):3>this.args.length?this.error("no sequence values specified"):void(Array.isArray(this.args[1])||"Object"==Util.toStringTag(this.args[1])?MQBN.createSequence(this.args[0],this.args[2],this.args[1]):MQBN.createSequence(this.args[0],this.args.slice(2),this.args[1]))}}),Macro.add(["sequenceadvance","sequencerewind"],{handler:function(){if(0===this.args.length)return this.error("no sequence name specified");let a=this.args[1]??1;"sequencerewind"==this.name&&(a=-1*a);const b=State.getVar(this.args[0]);b.sequenceChange(a),State.setVar(this.args[0],b)}});