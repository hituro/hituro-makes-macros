setup.functions_macro??={prefix:"tw"},Macro.add("function",{tags:null,handler(){if(0===this.args.length)return this.error("no function name specified");const a=this.args[0],b=this,c=setup?.functions_macro?.prefix??"tw";c&&"undefined"==typeof window[c]&&(window[c]={});const d=c?window[c]:window;if(d[a])return this.error(`cannot clobber existing function "${a}"`);try{d[a]=function(a){return function(){const c={};State.temporary.hasOwnProperty("args")&&(c._args=State.temporary.args),State.temporary.hasOwnProperty("return")&&(c._return=State.temporary.return),State.temporary.args=[...arguments],b.addShadow("_args"),b.addShadow("_return");try{const c=document.createDocumentFragment(),d=[];return new Wikifier(c,a),Array.from(c.querySelectorAll(".error")).forEach(a=>{d.push(a.textContent)}),0===d.length?State.temporary.return:b.error(`error${1<d.length?"s":""} within function code (${d.join("; ")})`)}catch(a){return b.error(`cannot execute function: ${a.message}`)}finally{c.hasOwnProperty("_args")?State.temporary.args=c._args:delete State.temporary.args,c.hasOwnProperty("_return")?State.temporary.return=c._return:delete State.temporary.return}}}(this.payload[0].contents)}catch(b){return this.error(`cannot create function "${a}": ${b.message}`)}}}),Story.lookup("tags","functions").forEach(a=>{$.wiki(a.text)});